#!/usr/bin/python
# -*- coding: utf-8 -*-
#import libr
import os, sys
import telebot
import time
import datetime
from datetime import date
import shutil
from jproperties import Properties 

#open property
configs = Properties()
with open('app-config.properties', 'rb') as config_file: configs.load(config_file)

dic = configs.get("DIC").data
dicExc = configs.get("DIC-EXC").data
audit = configs.get("AUDIT").data
bkp = configs.get("BKP").data
path = configs.get("PATH").data


# token from botfather
bot = telebot.TeleBot('5384705861:AAFHHakPYBgzisLKJl1wsNxME9TBU_LfUvA') 
# function processing command start
#current_date = date.today()
@bot.message_handler(commands=["start"])
def start(m, res=False):
    bot.send_message(m.chat.id, '–ü—Ä–∏–≤–µ—Ç!üëê\n–û—Ç–ø—Ä–∞–≤–ª—è–π –º–Ω–µ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –Ω–∞–π—Ç–∏, —á—Ç–æ –æ–Ω–∏ –∑–Ω–∞—á–∞—Ç.')
# get essage from user
@bot.message_handler(content_types=["text"])
def handle_text(message):
        #logging
    dtn = datetime.datetime.now()
    botlogfile = open(audit, 'a')
    print(dtn.strftime("%d-%m-%Y %H:%M"), 'user ' + message.from_user.first_name, message.from_user.id, 'write: ' + message.text, file=botlogfile)
    botlogfile.close()
  #send bkp-dic file
    if message.text.lower() == 'get-bkp':
      with open(bkp,'rb') as doc:
        bot.send_document(message.chat.id, doc)
        bot.send_document(message.chat.id, "FILEID")
  #send audit file
    if message.text.lower() == 'get-audit':
      with open(audit,'rb') as doc:
        bot.send_document(message.chat.id, doc)
        bot.send_document(message.chat.id, "FILEID")
  #send dic file
    if message.text.lower() == 'get-dic':
      shutil.copyfile( dic, bkp )
      with open(dic,'rb') as doc:
        bot.send_document(message.chat.id, doc)
        bot.send_document(message.chat.id, "FILEID")
  #send not find abbr file
    if message.text.lower() == 'get-exc':
      with open(dicExc,'rb') as doc:
        bot.send_document(message.chat.id, doc)
        bot.send_document(message.chat.id, "FILEID") 
  #find abbr in dic
    FIND = message.text.upper()
    with open(dic, encoding="utf-8") as openfile:
        array = []
        for line in openfile:
            if FIND in line:
                array.append(line)
  #response exception message + save find abbr
    if not array:
        bot.send_message(message.chat.id,
'–ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ —è –µ–µ –∑–∞–ø–∏—Å–∞–ª.üôà\n\
–í–æ–∑–≤—Ä–∞—âa–π—Å—è –ø–æ–∑–∂–µ –∏ —è —Å–º–æ–≥—É —Ç–µ–±–µ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å.\n\
–¢—ã –º–æ–∂–µ—à—å –ø—Ä–∏—Å–ª–∞—Ç—å –º–Ω–µ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: \n–ê–ë–†-—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞.\n\
–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–±–±—Ä–∏–≤–∏–∞—Ç—É—Ä–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–æ–≤–∞—Ä—å.')
        exc=open(dicExc, 'a')
        exc.write('\n' + FIND)
        exc.close()
        #bot.send_message(message.chat.id,
#'–ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Å–ª–æ–≤–∞—Ä—å')
    else:
        for i in array:
            bot.send_message(message.chat.id, i)
  #get new dic
@bot.message_handler(content_types=['document']) # –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–≥–æ —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –±–æ—Ç
def addfile(message):
    os.remove(dic)
    file_info = bot.get_file(message.document.file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    src = path + message.document.file_name;
    with open(src, 'wb') as new_file:
        new_file.write(downloaded_file)
    file_oldname = os.path.join(path, message.document.file_name)
    file_newname_newfile = os.path.join(path, "dic.txt")
    os.rename(file_oldname, file_newname_newfile)
    bot.reply_to(message, "–°–ª–æ–≤–∞—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω")
# from debug start bot
bot.polling(none_stop=True, interval=0)



     
